{
  "$schema": "https://struere.dev/schemas/entity-type/v1.json",
  "name": "Entitlement",
  "slug": "entitlement",
  "description": "A session pack or credit entitlement purchased by a guardian for a student",
  "schema": {
    "type": "object",
    "properties": {
      "type": {
        "type": "string",
        "enum": ["single_session", "pack_5", "pack_10", "pack_20", "monthly_unlimited", "custom"],
        "description": "Type of entitlement package"
      },
      "sessionsRemaining": {
        "type": "integer",
        "minimum": 0,
        "description": "Number of sessions remaining (null for unlimited packages)"
      },
      "sessionsTotal": {
        "type": "integer",
        "minimum": 1,
        "description": "Total sessions included in the package"
      },
      "expiresAt": {
        "type": "string",
        "format": "date-time",
        "description": "Expiration date of the entitlement (ISO 8601)"
      },
      "purchasedAt": {
        "type": "string",
        "format": "date-time",
        "description": "When the entitlement was purchased (ISO 8601)"
      },
      "subjects": {
        "type": "array",
        "items": { "type": "string" },
        "description": "Subjects this entitlement can be used for (empty = all subjects)"
      },
      "notes": {
        "type": "string",
        "maxLength": 500,
        "description": "Additional notes about the entitlement"
      }
    },
    "required": ["type", "purchasedAt"]
  },
  "statuses": {
    "values": ["active", "exhausted", "expired", "cancelled"],
    "default": "active",
    "transitions": {
      "active": ["exhausted", "expired", "cancelled"],
      "exhausted": [],
      "expired": [],
      "cancelled": []
    }
  },
  "indexMapping": {
    "idx_num_0": "sessionsRemaining",
    "idx_date_0": "expiresAt",
    "idx_0": "type"
  },
  "searchFields": ["type", "notes"],
  "displayConfig": {
    "titleField": "type",
    "subtitleField": "sessionsRemaining",
    "listFields": ["type", "sessionsRemaining", "sessionsTotal", "expiresAt", "purchasedAt"],
    "detailSections": [
      {
        "title": "Package Details",
        "fields": ["type", "sessionsRemaining", "sessionsTotal"]
      },
      {
        "title": "Validity",
        "fields": ["purchasedAt", "expiresAt"]
      },
      {
        "title": "Restrictions",
        "fields": ["subjects", "notes"]
      }
    ]
  },
  "hooks": {
    "afterCreate": ["schedule_expiry_check"],
    "afterUpdate": {
      "sessionsRemaining": ["check_exhaustion"]
    },
    "afterStatusChange": {
      "exhausted": ["notify_pack_exhausted"],
      "expired": ["notify_pack_expired"]
    }
  },
  "computed": {
    "utilizationPercent": {
      "formula": "((sessionsTotal - sessionsRemaining) / sessionsTotal) * 100",
      "description": "Percentage of sessions used"
    },
    "daysUntilExpiry": {
      "formula": "dateDiff(now(), expiresAt, 'days')",
      "description": "Days remaining until expiration"
    }
  }
}
