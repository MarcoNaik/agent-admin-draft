# E2B, Sandbox-Agent & OpenCode Integration Roadmap

## Mission

Enable users to create, configure, and interact with AI coding agents directly from the Struere dashboard's Studio view. A user starts a studio session, which provisions a cloud sandbox (E2B), installs a coding agent (OpenCode or Claude Code) via sandbox-agent, and exposes a real-time chat interface with human-in-the-loop controls (permissions, questions). The agent operates on a scaffolded Struere project inside the sandbox and can sync changes back to the platform via `struere dev --force`.

---

## Architecture

```
Browser (Dashboard /studio)
    │
    ├── POST /api/studio/sessions          → Create sandbox, install agent, create ACP session
    ├── GET  /api/studio/sessions/[id]/events   → SSE proxy to sandbox ACP server
    ├── POST /api/studio/sessions/[id]/message  → Forward user prompt via ACP JSON-RPC
    ├── POST /api/studio/sessions/[id]/permission → Reply to permission requests
    ├── POST /api/studio/sessions/[id]/question   → Reply to question requests
    ├── POST /api/studio/sessions/[id]/keepalive  → Prevent idle timeout
    └── DELETE /api/studio/sessions/[id]          → Stop session, kill sandbox
            │
            ▼
    E2B Sandbox (cloud Linux VM)
        └── sandbox-agent server (Rust binary, port 3000)
                └── opencode acp (agent process)
```

### Protocol: ACP (Agent Client Protocol)

All agent communication uses ACP JSON-RPC over Streamable HTTP:

- **POST** `/v1/acp/{serverId}` — Send JSON-RPC requests (initialize, session/new, session/prompt, permission/reply, question/reply)
- **GET** `/v1/acp/{serverId}` — SSE stream of server-initiated events (session updates, agent messages, tool calls)
- **DELETE** `/v1/acp/{serverId}` — Close ACP server (destroys the connection)

The `serverId` is **client-defined** — generated by the SDK as `sdk-{agent}-{uuid}`.

---

## Documentation & Resources

### E2B (Cloud Sandbox Provider)

| Resource | URL |
|----------|-----|
| Documentation | https://e2b.dev/docs |
| SDK Reference (JS) | https://e2b.dev/docs/sdk-reference |
| GitHub (core) | https://github.com/e2b-dev/E2B |
| GitHub (code-interpreter) | https://github.com/e2b-dev/code-interpreter |
| npm package | https://www.npmjs.com/package/@e2b/code-interpreter |
| Sandbox connect docs | https://e2b.dev/docs/sandbox/connect |
| Internet access docs | https://e2b.dev/docs/sandbox/internet-access |
| Port issue thread | https://github.com/e2b-dev/e2b/issues/863 |

**Key SDK methods:**
- `Sandbox.create({ timeoutMs, envs, allowInternetAccess, apiKey })` — Create sandbox
- `sandbox.commands.run(cmd, { timeoutMs, background })` — Run commands
- `sandbox.getHost(port)` — Get external hostname for a port (returns `{port}-{sandboxId}.e2b.app`)
- `sandbox.files.write(path, content)` — Write files
- `Sandbox.kill(sandboxId)` — Destroy sandbox
- `Sandbox.connect(sandboxId)` — Reconnect to existing sandbox
- `Sandbox.list()` — List running sandboxes

### Sandbox-Agent (Universal Agent API)

| Resource | URL |
|----------|-----|
| GitHub | https://github.com/rivet-dev/sandbox-agent |
| CLAUDE.md (architecture) | https://github.com/rivet-dev/sandbox-agent/blob/main/CLAUDE.md |
| Documentation site | https://sandboxagent.dev/docs |
| E2B deployment guide | https://sandboxagent.dev/docs/deploy/e2b |
| npm (SDK) | https://www.npmjs.com/package/sandbox-agent |
| npm (ACP client) | https://www.npmjs.com/package/acp-http-client |
| Blog announcement | https://www.rivet.dev/changelog/2026-01-28-sandbox-agent-sdk/ |
| Rivet Discord | https://rivet.dev/discord |

**Key SDK methods:**
- `SandboxAgent.connect({ baseUrl, token? })` — Constructor only, no network call
- `SandboxAgent.start({ spawn? })` — Start embedded server locally
- `sdk.createSession({ agent, sessionInit: { cwd, mcpServers } })` — Create agent session (triggers ACP init + SSE loop)
- `sdk.resumeSession(id)` — Resume existing session
- `sdk.destroySession(id)` — Destroy session
- `sdk.listAcpServers()` — List active ACP servers
- `sdk.getHealth()` — Health check
- `sdk.listAgents()` — List available agents
- `sdk.installAgent(agent)` — Install agent
- `session.prompt(prompt)` — Send prompt (convenience wrapper)
- `session.send(method, params)` — Send arbitrary ACP method
- `session.onEvent(listener)` — Subscribe to session events
- `sdk.dispose()` — Close all ACP connections (sends DELETE — destroys servers!)

**Server CLI:**
```bash
curl -fsSL https://releases.rivet.dev/sandbox-agent/0.2.x/install.sh | sh
sandbox-agent install-agent opencode
sandbox-agent install-agent claude
sandbox-agent server --no-token --host 0.0.0.0 --port 3000
```

**Control-plane HTTP endpoints:**
- `GET /v1/health` — Health check
- `GET /v1/agents` — List agents
- `POST /v1/agents/{agent}/install` — Install agent
- `GET /v1/acp` — List ACP servers

### Agent Client Protocol (ACP)

| Resource | URL |
|----------|-----|
| ACP specification | https://agentclientprotocol.dev/introduction/welcome |
| GitHub | https://github.com/agentclientprotocol/agent-client-protocol |
| npm (@agentclientprotocol/sdk) | https://www.npmjs.com/package/@agentclientprotocol/sdk |
| JetBrains ACP docs | https://www.jetbrains.com/help/ai-assistant/acp.html |
| Vercel AI SDK ACP provider | https://ai-sdk.dev/providers/community-providers/acp |

### OpenCode (Coding Agent)

| Resource | URL |
|----------|-----|
| GitHub | https://github.com/nichochar/opencode |

---

## Current State & Files Modified

### Dashboard Files (apps/dashboard/)

| File | Purpose | Status |
|------|---------|--------|
| `src/app/api/studio/sessions/route.ts` | Session creation (POST) — creates sandbox, installs agent, creates ACP session | **Modified** — removed `sdk.dispose()` |
| `src/app/api/studio/sessions/[id]/route.ts` | Session deletion (DELETE) — cleanup | Existing |
| `src/app/api/studio/sessions/[id]/events/route.ts` | SSE proxy — raw fetch to `GET /v1/acp/{serverId}` | Existing |
| `src/app/api/studio/sessions/[id]/message/route.ts` | Message forwarding — raw fetch POST to ACP | Existing |
| `src/app/api/studio/sessions/[id]/permission/route.ts` | Permission reply forwarding | Existing |
| `src/app/api/studio/sessions/[id]/question/route.ts` | Question reply forwarding | Existing |
| `src/app/api/studio/sessions/[id]/keepalive/route.ts` | Activity heartbeat | Existing |
| `src/lib/studio/e2b.ts` | E2B sandbox creation/destruction, `waitForServer()` health polling | **Modified** — auto-runs `struere dev --force` in background |
| `src/lib/studio/client.ts` | Convex client, ACP JSON-RPC wrappers (`postMessageToSandbox`, etc.) | Existing |
| `src/lib/studio/project.ts` | Generate scaffold files from pull state | Existing |
| `src/hooks/use-studio-session.ts` | Session lifecycle (start, stop, keepalive) | Existing |
| `src/hooks/use-studio-events.ts` | SSE connection, ACP event parsing, message streaming | **Modified** — TurnTracking for sequential thinking/message blocks |
| `src/components/studio/studio-chat.tsx` | Chat input + message list container | **Modified** — removed isConnected from inputDisabled |
| `src/components/studio/studio-message-list.tsx` | Message rendering, thinking blocks | **Modified** — always-expanded thinking blocks |
| `src/components/studio/studio-tool-activity.tsx` | Tool call/result/file ref cards | **Modified** — always-expanded inline display (no collapsible) |
| `debug-acp-sse.mjs` | Debug script for E2B + ACP integration testing | **Created** |

### Platform Files (platform/convex/)

| File | Purpose | Status |
|------|---------|--------|
| `sandboxSessions.ts` | Convex mutations/queries for session management | Existing |
| `schema.ts` | Database schema (includes `sandboxSessions`, `sandboxEvents` tables) | Existing |
| `sync.ts` | CLI sync mutations/queries | **Modified** — added internal sync functions for API key auth |
| `http.ts` | HTTP router for all external endpoints | **Modified** — added `/v1/sync`, `/v1/sync/state`, `/v1/sync/pull` routes |

### CLI Files (packages/struere/)

| File | Purpose | Status |
|------|---------|--------|
| `src/cli/utils/convex.ts` | Convex API client for sync operations | **Modified** — HTTP routing for headless API key mode |
| `src/cli/commands/dev.ts` | `struere dev` command | **Modified** — headless mode detection, skip interactive prompts |
| `src/cli/utils/loader.ts` | Resource loader (imports .ts files) | **Modified** — improved error reporting with full stack traces |

### Dependency Versions

| Package | Version |
|---------|---------|
| `@e2b/code-interpreter` | `^1` |
| `sandbox-agent` | `0.2.0` |
| `acp-http-client` | `0.1.0` (transitive via sandbox-agent) |
| `@agentclientprotocol/sdk` | (transitive via acp-http-client) |

---

## Bugs Found & Fixed

### Bug 1: `sdk.dispose()` destroys ACP server (FIXED)

**Root cause:** `sdk.dispose()` calls `LiveAcpConnection.close()` → `AcpHttpClient.disconnect()` → sends `DELETE /v1/acp/{serverId}`. This destroys the ACP server on the sandbox-agent side. The events route then gets 404 when trying to proxy SSE through that server ID.

**Commit:** `c327e5e` — `fix(studio/sessions): remove sdk.dispose() to keep ACP server alive for SSE proxy`

### Bug 2: SDK SSE loop lingers in Vercel serverless (FIXED)

**Root cause:** The sandbox-agent SDK opens an internal SSE loop during `createSession()` that lingers in the warm Vercel serverless process. This SSE loop competes with the events route's SSE proxy for the same ACP server, causing "Got response to unknown request N" errors and preventing events from reaching the frontend.

**Fix:** Replaced SDK usage with direct ACP JSON-RPC HTTP calls — two POSTs (initialize + session/new). No SDK instance means no SSE loop, no competing consumers.

**Commit:** `4ad71e6` — `fix(studio/sessions): replace SDK with raw ACP HTTP for session creation`

**Key detail:** ACP `protocolVersion` is the integer `1` (not a date string).

### Bug 3: Bun not in PATH for sandbox processes (FIXED)

**Root cause:** Bun was installed in the sandbox (`curl -fsSL https://bun.sh/install | bash`) but only added to `$HOME/.bun/bin`. The `sandbox-agent server` process and its child processes (OpenCode spawning shell commands) don't inherit that PATH, so `bun` was not found.

**Fix:** Added symlinks after bun install: `ln -sf $HOME/.bun/bin/bun /usr/local/bin/bun && ln -sf $HOME/.bun/bin/bunx /usr/local/bin/bunx`. This puts bun in the default PATH for all processes.

**File:** `apps/dashboard/src/lib/studio/e2b.ts`

### Bug 4: Only text messages rendered in Studio UI (FIXED)

**Root cause:** The `useStudioEvents` hook tracked tool calls, file changes, and thinking internally in the `items` Map, but only exposed `messages` (filtered to `kind === "message"`). The message list component only rendered message bubbles.

**Fix:** Multi-file change to stream all agent activity to the UI:

- **`use-studio-events.ts`** — Added `allItems` export (all `ItemState[]` sorted by `createdAt`). Added `agent_thought_chunk` handling (creates/appends to `kind: "thinking"` items). Added HITL event detection from both ACP methods (`permission/request`, `question/request`) and sessionUpdate types (`permission_requested`, `question_asked`). Added `session_ended` and `error` handling (creates system message items, sets error state).
- **`studio-message-list.tsx`** — Rewritten to accept `items: ItemState[]` instead of `messages: StudioMessage[]`. Renders chronologically: messages → MessageBubble, tool_call → ToolCallCard (with spinner), file_change → FileChangeCard, thinking → collapsible ThinkingBlock. System messages render centered.
- **`studio-chat.tsx`** — Changed prop from `messages` to `items: ItemState[]`.
- **`studio/page.tsx`** — Wired `allItems` from hook through to `StudioChat`.

### Bug 5: "Connecting..." stuck input after agent turn (FIXED)

**Root cause:** After the agent finishes a turn, the ACP SSE stream closes (by design). EventSource fires `onerror` → `isConnected=false`. `inputDisabled` included `!isConnected`, so the input showed "Connecting..." and was disabled until SSE reconnected.

**Fix:** Removed `isConnected` from `inputDisabled` calculation. Messages go through POST which doesn't need SSE. SSE auto-reconnects in the background. Kept the "SSE Connected" indicator in the header for visibility.

**File:** `apps/dashboard/src/components/studio/studio-chat.tsx`

### Bug 6: Thinking and messages merged into single bubbles (FIXED)

**Root cause:** `processAcpEvent` used fixed IDs per turn — `thinking-${turnId}` and `assistant-${turnId}`. When the agent alternated between thinking and messaging (think → message → think → message), all thinking chunks were appended to one item and all message chunks to another, rendering as one thinking block and one message block.

**Fix:** Introduced `TurnTracking` state that tracks `lastChunkType`, `activeMessageId`, `activeThinkingId`, and a `subIdx` counter. When the agent switches from thinking→message or message→thinking:
1. The current active item is finalized (deltas merged into content, status set to "completed")
2. A new item is created with unique ID (`assistant-${turnId}-${subIdx}` or `thinking-${turnId}-${subIdx}`)
3. Counter increments

Each alternation now appears as a separate sequential block in the UI.

**File:** `apps/dashboard/src/hooks/use-studio-events.ts`

### Bug 7: CLI auth broken in sandbox — headless mode (FIXED)

**Root cause:** `STRUERE_API_KEY` is passed to the sandbox, but the CLI sent it as `Bearer <api-key>` to Convex's `/api/mutation` endpoint. Convex only validates JWTs there — raw API keys fail. So `struere dev` triggered the interactive `performLogin()` prompt, which hangs in the headless sandbox.

**Fix:** Multi-layer fix:

1. **New HTTP sync endpoints** (`platform/convex/http.ts`) — Added `POST /v1/sync`, `POST /v1/sync/state`, `POST /v1/sync/pull` that accept Bearer API key auth. These validate the API key via SHA-256 hash lookup (same pattern as `/v1/chat`) and call internal sync functions.

2. **Internal sync functions** (`platform/convex/sync.ts`) — Added `internalSyncOrganization`, `internalGetSyncState`, `internalGetPullState` as `internalMutation`/`internalQuery` that accept `organizationId` as `Id<"organizations">` directly, bypassing Clerk auth.

3. **CLI routing** (`packages/struere/src/cli/utils/convex.ts`) — When `STRUERE_API_KEY` is set and no JWT credentials exist (headless mode), `syncOrganization()`, `getSyncState()`, and `getPullState()` route through the new HTTP endpoints on the `.site` domain instead of `/api/mutation` on `.cloud`.

4. **CLI headless mode** (`packages/struere/src/cli/commands/dev.ts`) — Detects headless mode, skips interactive `confirm()` prompts (auto-force), skips `performLogin()` re-auth (shows clear error instead), shows "Auth: API key (headless)" indicator.

5. **Better error reporting** (`packages/struere/src/cli/utils/loader.ts`) — `importUserFile()` now captures full stack traces on import errors so the sandbox agent can debug compilation failures.

**Files:** `platform/convex/http.ts`, `platform/convex/sync.ts`, `packages/struere/src/cli/utils/convex.ts`, `packages/struere/src/cli/commands/dev.ts`, `packages/struere/src/cli/utils/loader.ts`

### Bug 8: `struere dev` not auto-running in sandbox (FIXED)

**Root cause:** The agent had to manually run `struere dev --force` in the sandbox. It should already be running in the background when the sandbox starts.

**Fix:** Added background command in `createSandbox()` after installing struere and before starting sandbox-agent server:
```bash
export BUN_INSTALL="$HOME/.bun" && export PATH="$BUN_INSTALL/bin:/usr/local/bin:$PATH" && cd /workspace && struere dev --force
```

**File:** `apps/dashboard/src/lib/studio/e2b.ts`

---

## Test Scripts

| Script | Purpose | Usage |
|--------|---------|-------|
| `test-e2e-studio.mjs` | E2E test against raw E2B sandbox (no auth needed) | `bun run test-e2e-studio.mjs` |
| `test-e2e-production.mjs` | E2E test against deployed app.struere.dev (needs Clerk session) | `bun run test-e2e-production.mjs <__session cookie>` |
| `debug-acp-sse.mjs` | Diagnostic script for debugging sandbox-agent issues | `bun run debug-acp-sse.mjs` |

### E2E sandbox test covers (16 checks):
1. Sandbox creation
2. sandbox-agent + opencode install
3. Server health (internal + external)
4. ACP initialize via raw HTTP
5. session/new via raw HTTP
6. ACP server listing
7. SSE connection
8. Prompt → agent response via SSE
9. Multi-turn conversation
10. SSE reconnect (page reload simulation)
11. Prompt after reconnect

### Production test covers (11 checks):
1. Auth validation
2. Session creation (full provisioning)
3. SSE event stream connection
4. Message send + receive via SSE
5. Agent response text extraction
6. Multi-turn conversation
7. SSE reconnect
8. Prompt after reconnect
9. Keepalive
10. Session stop/cleanup

---

## Next Steps

1. ~~**Run production test after Vercel deploy**~~ — ✅ Done
2. ~~**Fix bun PATH in sandbox**~~ — ✅ Fixed (symlinks to /usr/local/bin)
3. ~~**Stream all agent activity to UI**~~ — ✅ Done (tool calls, file changes, thinking, errors)
4. ~~**Fix "Connecting..." stuck input**~~ — ✅ Fixed (removed isConnected from inputDisabled)
5. ~~**Fix thinking/message sequential rendering**~~ — ✅ Fixed (TurnTracking with subIdx counter)
6. ~~**Fix CLI auth in sandbox (headless mode)**~~ — ✅ Fixed (HTTP sync endpoints + API key routing)
7. ~~**Auto-run `struere dev --force` in sandbox**~~ — ✅ Fixed (background command in e2b.ts)
8. ~~**Make tool calls show raw inline**~~ — ✅ Fixed (always-expanded, no collapsible)
9. ~~**Improve CLI error reporting**~~ — ✅ Fixed (full stack traces in loader)
10. **Deploy Convex** — New HTTP sync endpoints need `npx convex deploy` to be available
11. **Publish CLI** — Updated struere CLI needs `npm publish` for sandbox to install latest
12. **Test HITL flows** — Permission requests and question requests round-trip correctly
13. **Test session resume** — Reconnecting to an existing sandbox after page reload
14. **Test session cleanup** — Idle timeout, manual stop, sandbox destruction
15. **Handle agent types** — Claude Code vs OpenCode differences
16. **Error recovery** — Sandbox crashes, network failures, ACP server reconnection
