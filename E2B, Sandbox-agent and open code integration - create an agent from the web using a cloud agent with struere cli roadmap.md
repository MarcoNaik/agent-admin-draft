# E2B, Sandbox-Agent & OpenCode Integration Roadmap

## Mission

Enable users to create, configure, and interact with AI coding agents directly from the Struere dashboard's Studio view. A user starts a studio session, which provisions a cloud sandbox (E2B), installs a coding agent (OpenCode or Claude Code) via sandbox-agent, and exposes a real-time chat interface with human-in-the-loop controls (permissions, questions). The agent operates on a scaffolded Struere project inside the sandbox and can sync changes back to the platform via `struere dev --force`.

---

## Architecture

```
Browser (Dashboard /studio)
    │
    ├── POST /api/studio/sessions          → Create sandbox, install agent, create ACP session
    ├── GET  /api/studio/sessions/[id]/events   → SSE proxy to sandbox ACP server
    ├── POST /api/studio/sessions/[id]/message  → Forward user prompt via ACP JSON-RPC
    ├── POST /api/studio/sessions/[id]/permission → Reply to permission requests
    ├── POST /api/studio/sessions/[id]/question   → Reply to question requests
    ├── POST /api/studio/sessions/[id]/keepalive  → Prevent idle timeout
    └── DELETE /api/studio/sessions/[id]          → Stop session, kill sandbox
            │
            ▼
    E2B Sandbox (cloud Linux VM)
        └── sandbox-agent server (Rust binary, port 3000)
                └── opencode acp (agent process)
```

### Protocol: ACP (Agent Client Protocol)

All agent communication uses ACP JSON-RPC over Streamable HTTP:

- **POST** `/v1/acp/{serverId}` — Send JSON-RPC requests (initialize, session/new, session/prompt, permission/reply, question/reply)
- **GET** `/v1/acp/{serverId}` — SSE stream of server-initiated events (session updates, agent messages, tool calls)
- **DELETE** `/v1/acp/{serverId}` — Close ACP server (destroys the connection)

The `serverId` is **client-defined** — generated by the SDK as `sdk-{agent}-{uuid}`.

---

## Documentation & Resources

### E2B (Cloud Sandbox Provider)

| Resource | URL |
|----------|-----|
| Documentation | https://e2b.dev/docs |
| SDK Reference (JS) | https://e2b.dev/docs/sdk-reference |
| GitHub (core) | https://github.com/e2b-dev/E2B |
| GitHub (code-interpreter) | https://github.com/e2b-dev/code-interpreter |
| npm package | https://www.npmjs.com/package/@e2b/code-interpreter |
| Sandbox connect docs | https://e2b.dev/docs/sandbox/connect |
| Internet access docs | https://e2b.dev/docs/sandbox/internet-access |
| Port issue thread | https://github.com/e2b-dev/e2b/issues/863 |

**Key SDK methods:**
- `Sandbox.create({ timeoutMs, envs, allowInternetAccess, apiKey })` — Create sandbox
- `sandbox.commands.run(cmd, { timeoutMs, background })` — Run commands
- `sandbox.getHost(port)` — Get external hostname for a port (returns `{port}-{sandboxId}.e2b.app`)
- `sandbox.files.write(path, content)` — Write files
- `Sandbox.kill(sandboxId)` — Destroy sandbox
- `Sandbox.connect(sandboxId)` — Reconnect to existing sandbox
- `Sandbox.list()` — List running sandboxes

### Sandbox-Agent (Universal Agent API)

| Resource | URL |
|----------|-----|
| GitHub | https://github.com/rivet-dev/sandbox-agent |
| CLAUDE.md (architecture) | https://github.com/rivet-dev/sandbox-agent/blob/main/CLAUDE.md |
| Documentation site | https://sandboxagent.dev/docs |
| E2B deployment guide | https://sandboxagent.dev/docs/deploy/e2b |
| npm (SDK) | https://www.npmjs.com/package/sandbox-agent |
| npm (ACP client) | https://www.npmjs.com/package/acp-http-client |
| Blog announcement | https://www.rivet.dev/changelog/2026-01-28-sandbox-agent-sdk/ |
| Rivet Discord | https://rivet.dev/discord |

**Key SDK methods:**
- `SandboxAgent.connect({ baseUrl, token? })` — Constructor only, no network call
- `SandboxAgent.start({ spawn? })` — Start embedded server locally
- `sdk.createSession({ agent, sessionInit: { cwd, mcpServers } })` — Create agent session (triggers ACP init + SSE loop)
- `sdk.resumeSession(id)` — Resume existing session
- `sdk.destroySession(id)` — Destroy session
- `sdk.listAcpServers()` — List active ACP servers
- `sdk.getHealth()` — Health check
- `sdk.listAgents()` — List available agents
- `sdk.installAgent(agent)` — Install agent
- `session.prompt(prompt)` — Send prompt (convenience wrapper)
- `session.send(method, params)` — Send arbitrary ACP method
- `session.onEvent(listener)` — Subscribe to session events
- `sdk.dispose()` — Close all ACP connections (sends DELETE — destroys servers!)

**Server CLI:**
```bash
curl -fsSL https://releases.rivet.dev/sandbox-agent/0.2.x/install.sh | sh
sandbox-agent install-agent opencode
sandbox-agent install-agent claude
sandbox-agent server --no-token --host 0.0.0.0 --port 3000
```

**Control-plane HTTP endpoints:**
- `GET /v1/health` — Health check
- `GET /v1/agents` — List agents
- `POST /v1/agents/{agent}/install` — Install agent
- `GET /v1/acp` — List ACP servers

### Agent Client Protocol (ACP)

| Resource | URL |
|----------|-----|
| ACP specification | https://agentclientprotocol.dev/introduction/welcome |
| GitHub | https://github.com/agentclientprotocol/agent-client-protocol |
| npm (@agentclientprotocol/sdk) | https://www.npmjs.com/package/@agentclientprotocol/sdk |
| JetBrains ACP docs | https://www.jetbrains.com/help/ai-assistant/acp.html |
| Vercel AI SDK ACP provider | https://ai-sdk.dev/providers/community-providers/acp |

### OpenCode (Coding Agent)

| Resource | URL |
|----------|-----|
| GitHub | https://github.com/nichochar/opencode |

---

## Current State & Files Modified

### Dashboard Files (apps/dashboard/)

| File | Purpose | Status |
|------|---------|--------|
| `src/app/api/studio/sessions/route.ts` | Session creation (POST) — creates sandbox, installs agent, creates ACP session | **Modified** — removed `sdk.dispose()` |
| `src/app/api/studio/sessions/[id]/route.ts` | Session deletion (DELETE) — cleanup | Existing |
| `src/app/api/studio/sessions/[id]/events/route.ts` | SSE proxy — raw fetch to `GET /v1/acp/{serverId}` | Existing |
| `src/app/api/studio/sessions/[id]/message/route.ts` | Message forwarding — raw fetch POST to ACP | Existing |
| `src/app/api/studio/sessions/[id]/permission/route.ts` | Permission reply forwarding | Existing |
| `src/app/api/studio/sessions/[id]/question/route.ts` | Question reply forwarding | Existing |
| `src/app/api/studio/sessions/[id]/keepalive/route.ts` | Activity heartbeat | Existing |
| `src/lib/studio/e2b.ts` | E2B sandbox creation/destruction, `waitForServer()` health polling | Existing |
| `src/lib/studio/client.ts` | Convex client, ACP JSON-RPC wrappers (`postMessageToSandbox`, etc.) | Existing |
| `src/lib/studio/project.ts` | Generate scaffold files from pull state | Existing |
| `src/hooks/use-studio-session.ts` | Session lifecycle (start, stop, keepalive) | Existing |
| `src/hooks/use-studio-events.ts` | SSE connection, ACP event parsing, message streaming | Existing |
| `debug-acp-sse.mjs` | Debug script for E2B + ACP integration testing | **Created** |

### Platform Files (platform/convex/)

| File | Purpose | Status |
|------|---------|--------|
| `sandboxSessions.ts` | Convex mutations/queries for session management | Existing |
| `schema.ts` | Database schema (includes `sandboxSessions`, `sandboxEvents` tables) | Existing |

### Dependency Versions

| Package | Version |
|---------|---------|
| `@e2b/code-interpreter` | `^1` |
| `sandbox-agent` | `0.2.0` |
| `acp-http-client` | `0.1.0` (transitive via sandbox-agent) |
| `@agentclientprotocol/sdk` | (transitive via acp-http-client) |

---

## Bugs Found & Fixed

### Bug 1: `sdk.dispose()` destroys ACP server (FIXED)

**Root cause:** `sdk.dispose()` calls `LiveAcpConnection.close()` → `AcpHttpClient.disconnect()` → sends `DELETE /v1/acp/{serverId}`. This destroys the ACP server on the sandbox-agent side. The events route then gets 404 when trying to proxy SSE through that server ID.

**Commit:** `c327e5e` — `fix(studio/sessions): remove sdk.dispose() to keep ACP server alive for SSE proxy`

### Bug 2: SDK SSE loop lingers in Vercel serverless (FIXED)

**Root cause:** The sandbox-agent SDK opens an internal SSE loop during `createSession()` that lingers in the warm Vercel serverless process. This SSE loop competes with the events route's SSE proxy for the same ACP server, causing "Got response to unknown request N" errors and preventing events from reaching the frontend.

**Fix:** Replaced SDK usage with direct ACP JSON-RPC HTTP calls — two POSTs (initialize + session/new). No SDK instance means no SSE loop, no competing consumers.

**Commit:** `4ad71e6` — `fix(studio/sessions): replace SDK with raw ACP HTTP for session creation`

**Key detail:** ACP `protocolVersion` is the integer `1` (not a date string).

### Bug 3: Bun not in PATH for sandbox processes (FIXED)

**Root cause:** Bun was installed in the sandbox (`curl -fsSL https://bun.sh/install | bash`) but only added to `$HOME/.bun/bin`. The `sandbox-agent server` process and its child processes (OpenCode spawning shell commands) don't inherit that PATH, so `bun` was not found.

**Fix:** Added symlinks after bun install: `ln -sf $HOME/.bun/bin/bun /usr/local/bin/bun && ln -sf $HOME/.bun/bin/bunx /usr/local/bin/bunx`. This puts bun in the default PATH for all processes.

**File:** `apps/dashboard/src/lib/studio/e2b.ts`

### Bug 4: Only text messages rendered in Studio UI (FIXED)

**Root cause:** The `useStudioEvents` hook tracked tool calls, file changes, and thinking internally in the `items` Map, but only exposed `messages` (filtered to `kind === "message"`). The message list component only rendered message bubbles.

**Fix:** Multi-file change to stream all agent activity to the UI:

- **`use-studio-events.ts`** — Added `allItems` export (all `ItemState[]` sorted by `createdAt`). Added `agent_thought_chunk` handling (creates/appends to `kind: "thinking"` items). Added HITL event detection from both ACP methods (`permission/request`, `question/request`) and sessionUpdate types (`permission_requested`, `question_asked`). Added `session_ended` and `error` handling (creates system message items, sets error state).
- **`studio-message-list.tsx`** — Rewritten to accept `items: ItemState[]` instead of `messages: StudioMessage[]`. Renders chronologically: messages → MessageBubble, tool_call → ToolCallCard (with spinner), file_change → FileChangeCard, thinking → collapsible ThinkingBlock. System messages render centered.
- **`studio-chat.tsx`** — Changed prop from `messages` to `items: ItemState[]`.
- **`studio/page.tsx`** — Wired `allItems` from hook through to `StudioChat`.

---

## Test Scripts

| Script | Purpose | Usage |
|--------|---------|-------|
| `test-e2e-studio.mjs` | E2E test against raw E2B sandbox (no auth needed) | `bun run test-e2e-studio.mjs` |
| `test-e2e-production.mjs` | E2E test against deployed app.struere.dev (needs Clerk session) | `bun run test-e2e-production.mjs <__session cookie>` |
| `debug-acp-sse.mjs` | Diagnostic script for debugging sandbox-agent issues | `bun run debug-acp-sse.mjs` |

### E2E sandbox test covers (16 checks):
1. Sandbox creation
2. sandbox-agent + opencode install
3. Server health (internal + external)
4. ACP initialize via raw HTTP
5. session/new via raw HTTP
6. ACP server listing
7. SSE connection
8. Prompt → agent response via SSE
9. Multi-turn conversation
10. SSE reconnect (page reload simulation)
11. Prompt after reconnect

### Production test covers (11 checks):
1. Auth validation
2. Session creation (full provisioning)
3. SSE event stream connection
4. Message send + receive via SSE
5. Agent response text extraction
6. Multi-turn conversation
7. SSE reconnect
8. Prompt after reconnect
9. Keepalive
10. Session stop/cleanup

---

## Next Steps

1. ~~**Run production test after Vercel deploy**~~ — ✅ Done
2. ~~**Fix bun PATH in sandbox**~~ — ✅ Fixed (symlinks to /usr/local/bin)
3. ~~**Stream all agent activity to UI**~~ — ✅ Done (tool calls, file changes, thinking, errors)
4. **Test HITL flows** — Permission requests and question requests round-trip correctly
5. **Test session resume** — Reconnecting to an existing sandbox after page reload
6. **Test session cleanup** — Idle timeout, manual stop, sandbox destruction
7. **Handle agent types** — Claude Code vs OpenCode differences
8. **Error recovery** — Sandbox crashes, network failures, ACP server reconnection
